<?xml version="1.0" encoding="utf-8"?>
<Configuration status="WARN">

    <!-- ============================================== -->
    <!-- CORE BANKING SYSTEM API - LOG4J2 CONFIGURATION -->
    <!-- Banking-grade logging with sensitive data masking -->
    <!-- ============================================== -->

    <Properties>
        <!-- Application name for log files -->
        <Property name="APP_NAME">core-banking-system-api</Property>
        <!-- Log pattern with correlation ID for request tracing -->
        <Property name="LOG_PATTERN">%-5p %d{yyyy-MM-dd HH:mm:ss.SSS} [%t] [correlationId: %X{correlationId}] [processor: %X{processorPath}] %c{1}: %m%n</Property>
        <!-- Console pattern (simplified) -->
        <Property name="CONSOLE_PATTERN">%-5p %d{HH:mm:ss.SSS} [%X{correlationId}] %c{1}: %m%n</Property>
    </Properties>

    <Appenders>
        <!-- Rolling File Appender for main application logs -->
        <RollingFile name="file" 
                     fileName="${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${APP_NAME}.log"
                     filePattern="${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${APP_NAME}-%d{yyyy-MM-dd}-%i.log.gz">
            <!-- Pattern with correlation ID for distributed tracing -->
            <PatternLayout pattern="${LOG_PATTERN}"/>
            <Policies>
                <!-- Roll over daily -->
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <!-- Roll over at 50MB -->
                <SizeBasedTriggeringPolicy size="50 MB"/>
            </Policies>
            <!-- Keep 30 days of logs, max 20 files per day -->
            <DefaultRolloverStrategy max="20">
                <Delete basePath="${sys:mule.home}${sys:file.separator}logs" maxDepth="1">
                    <IfFileName glob="${APP_NAME}-*.log.gz"/>
                    <IfLastModified age="30d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!-- Rolling File Appender for audit logs (banking transactions) -->
        <RollingFile name="auditFile" 
                     fileName="${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${APP_NAME}-audit.log"
                     filePattern="${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${APP_NAME}-audit-%d{yyyy-MM-dd}-%i.log.gz">
            <PatternLayout pattern="${LOG_PATTERN}"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <SizeBasedTriggeringPolicy size="100 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="50">
                <Delete basePath="${sys:mule.home}${sys:file.separator}logs" maxDepth="1">
                    <IfFileName glob="${APP_NAME}-audit-*.log.gz"/>
                    <IfLastModified age="90d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!-- Console Appender for development -->
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${CONSOLE_PATTERN}"/>
        </Console>
    </Appenders>

    <Loggers>
        <!-- ============================================== -->
        <!-- HTTP LOGGING                                  -->
        <!-- ============================================== -->
        <!-- HTTP wire traffic - WARN in production to avoid sensitive data exposure -->
        <AsyncLogger name="org.mule.service.http.impl.service.HttpMessageLogger" level="WARN"/>
        <AsyncLogger name="org.mule.service.http" level="WARN"/>
        <AsyncLogger name="org.mule.extension.http" level="WARN"/>

        <!-- ============================================== -->
        <!-- APIKIT LOGGING                                -->
        <!-- ============================================== -->
        <AsyncLogger name="org.mule.module.apikit" level="WARN"/>

        <!-- ============================================== -->
        <!-- MULE RUNTIME LOGGING                          -->
        <!-- ============================================== -->
        <AsyncLogger name="org.mule.runtime.core.internal.processor.LoggerMessageProcessor" level="INFO"/>
        <AsyncLogger name="org.mule.runtime" level="WARN"/>

        <!-- ============================================== -->
        <!-- SECURITY LOGGING                              -->
        <!-- ============================================== -->
        <!-- Secure properties - never log at DEBUG -->
        <AsyncLogger name="com.mulesoft.modules.secure.properties" level="WARN"/>

        <!-- ============================================== -->
        <!-- OBJECT STORE LOGGING                          -->
        <!-- ============================================== -->
        <AsyncLogger name="org.mule.extension.objectstore" level="WARN"/>

        <!-- ============================================== -->
        <!-- APPLICATION LOGGING                           -->
        <!-- ============================================== -->
        <!-- Application-specific loggers -->
        <AsyncLogger name="com.bank.corebanking" level="INFO"/>

        <!-- ============================================== -->
        <!-- AUDIT LOGGER                                  -->
        <!-- Separate logger for banking audit trail       -->
        <!-- ============================================== -->
        <AsyncLogger name="AUDIT" level="INFO" additivity="false">
            <AppenderRef ref="auditFile"/>
        </AsyncLogger>

        <!-- ============================================== -->
        <!-- ROOT LOGGER                                   -->
        <!-- ============================================== -->
        <AsyncRoot level="INFO">
            <AppenderRef ref="file"/>
            <AppenderRef ref="Console"/>
        </AsyncRoot>
    </Loggers>

</Configuration>
